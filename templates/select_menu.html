<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ë‰´ ì„ íƒ</title>
    <link rel="stylesheet" href="/static/select_styles.css?v=9">
</head>
<body>
    <div class="update-banner">
        <div class="banner-title">ğŸ“¢ ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ì´ìŠˆ</div>
        <div class="banner-rolling">
          <div class="rolling-content" id="rollingContainer">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ì—¬ê¸°ì— 3ê°œ ì´ìŠˆ ìˆœí™˜ í‘œì‹œ -->
          </div>
        </div>
      </div>
    <div id="session-timer" style="
    position: fixed;
    top: 10px;
    left: 10px;
    background: #ffe5e5; /* ì—°í•œ ë¹¨ê°„ìƒ‰ ë°°ê²½ */
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    z-index: 9999;
    color: #800000; /* ê¸€ììƒ‰: ì§„í•œ ë¶‰ì€ìƒ‰ (maroon) */
    font-weight: bold;
">
    ë¡œê·¸ì¸ ë‚¨ì€ ì‹œê°„: <span id="time-left">30:00</span>
</div>
    <div class="container">
        <h1>{{ user.display_name }} íšŒì›ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</h1>
        <h2>ì›í•˜ëŠ” í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                <div class="menu-buttons">
            <a href="/issues" class="menu-btn pastel-blue">ë†ì•½ í˜„ì•ˆ ê´€ë¦¬</a>
            <a href="/review" class="menu-btn pastel-green">í˜„ì•ˆ ê²€í†  ê±´ì˜</a>
            <a href="/law-update" class="menu-btn pastel-orange">ë†ì•½ê´€ë¦¬ë²• ë° ê³ ì‹œ ê°œì • í˜„í™©</a>

            <!-- âœ… ì¶”ê°€ í•­ëª© ì‹œì‘ -->
            <a href="/wg-operation" class="menu-btn pastel-purple">ì‹¤ë¬´í˜‘ì˜ì²´(WG) ìš´ì˜</a>
            <a href="/supplements" class="menu-btn pastel-pink">ë“±ë¡ë³´ì™„ì‚¬í•­ ê´€ë¦¬</a>
            <!-- ì¶”ê°€ëœ í•­ëª© -->
            <a href="/test-review" class="menu-btn pastel-blue">ì‹œí—˜ì„¤ê³„ ê²€í†  ë° ê´€ë¦¬</a> <!-- ìƒˆ ë©”ë‰´ í•­ëª© -->
            <!-- âœ… ì¶”ê°€ í•­ëª© ë -->
        </div>
    </div>
    <div class="logout-container">
        <a href="/logout" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    {% if user.role == "admin" %}
<div class="admin-panel">
    <h3>ğŸ“ ê´€ë¦¬ì ë©”ë‰´</h3>
    <div class="admin-buttons">
        <a href="/dashboard" class="admin-btn">ğŸ“Š í†µê³„ ëŒ€ì‹œë³´ë“œ</a>
        <a href="/schedule/add" class="admin-btn">â• ì¼ì • ì¶”ê°€</a>
        <a href="/schedule/history" class="admin-btn">ğŸ“… ì¼ì • íˆìŠ¤í† ë¦¬ ë³´ê¸°</a>
        <a href="/admin/export-logins" class="admin-btn">ğŸ“„ ë¡œê·¸ì¸ ê¸°ë¡ CSV ë‹¤ìš´ë¡œë“œ</a>
    </div>
</div>
{% endif %}
    <script>
          window.userRole = "{{ user.role }}";
        let timeLeft = {{ session_seconds }};
    
        function formatTime(seconds) {
            const min = String(Math.floor(seconds / 60)).padStart(2, '0');
            const sec = String(seconds % 60).padStart(2, '0');
            return `${min}:${sec}`;
        }
    
        function updateTimer() {
            const timerEl = document.getElementById('time-left');
            timerEl.textContent = formatTime(timeLeft);
    
            if (timeLeft > 0) {
                timeLeft--;
            } else {
                alert("ì„¸ì…˜ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                window.location.href = "/logout";  // ì„¸ì…˜ ë§Œë£Œì‹œ ê°•ì œ ë¡œê·¸ì•„ì›ƒ
            }
        }
    
        setInterval(updateTimer, 1000); // 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
        let bannerTargetId = null;

        fetch("/api/latest-updates")
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById("rollingContainer");
    container.innerHTML = "";  // ê¸°ì¡´ í•­ëª© ì´ˆê¸°í™”

    // âœ… ìµœëŒ€ 5ê°œ ì²˜ë¦¬
    const issues = data.map(item => {
      const div = document.createElement("div");
      div.className = "rolling-item";
      div.innerHTML = `
      <a href="/issue/${item.id}">
        <span class="issue-date">[ ${item.updated_at} ]</span>
        <span class="issue-title">${item.name}</span>
      </a>
    `;
      return div;
    });

    // ë‘ ë°°ë¡œ ë³µì‚¬í•´ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ìˆœí™˜
    issues.forEach(i => container.appendChild(i));
    issues.forEach(i => container.appendChild(i.cloneNode(true)));

    let index = 0;
    const total = issues.length;

    setInterval(() => {
      index++;
      container.style.transform = `translateY(-${index * 40}px)`;

      if (index >= total) {
        setTimeout(() => {
          container.style.transition = "none";
          container.style.transform = `translateY(0px)`;
          index = 0;
          void container.offsetWidth; // ë¦¬í”Œë¡œìš°
          container.style.transition = "transform 1s ease-in-out";
        }, 600);
      }
    }, 3000);
  });

  async function loadScheduleWidget() {
    await fetch("/api/schedule/cleanup", { method: "POST" });
    const res = await fetch("/api/schedules");
    const data = await res.json();

    const list = document.getElementById("scheduleList");
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = "<tr><td colspan='4'>ì˜ˆì •ëœ ì¼ì • ì—†ìŒ</td></tr>";
        return;
    }

    for (const item of data) {
        const tr = document.createElement("tr");

        const dateCell = document.createElement("td");
        dateCell.style.whiteSpace = "normal";  // ğŸ”¥ ì¤„ë°”ê¿ˆ í—ˆìš©
        dateCell.style.wordBreak = "break-word"; // ê¸´ ë¬¸ìì—´ ì¤„ë°”ê¿ˆ
        dateCell.textContent = item.end_date
            ? `${item.start_date.replace(/-/g, '.')}~\n${item.end_date.replace(/-/g, '.')}`
            : item.start_date.replace(/-/g, '.');
        tr.appendChild(dateCell);

        const titleCell = document.createElement("td");
        titleCell.textContent = item.title;
        tr.appendChild(titleCell);

        const locationCell = document.createElement("td");
        locationCell.textContent = item.location || "";
        tr.appendChild(locationCell);

        // âœ… ê´€ë¦¬ìë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        if (window.userRole === "admin") {
            const deleteCell = document.createElement("td");
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "ì‚­ì œ";
            deleteBtn.style = "background-color: red; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;";
            deleteBtn.onclick = async () => {
                if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await fetch(`/schedule/delete/${item.id}`, { method: "POST" });
                    loadScheduleWidget();  // ì¬ë¡œë“œ
                }
            };
            deleteCell.appendChild(deleteBtn);
            tr.appendChild(deleteCell);
        }

        list.appendChild(tr);
    }
}
loadScheduleWidget();
function toggleScheduleWidget() {
  const widget = document.getElementById('scheduleWidget');
  const openBtn = document.getElementById('openScheduleBtn');
  const closeBtn = document.getElementById('closeScheduleBtn');

  if (widget.style.display === 'none') {
    widget.style.display = 'block';
    openBtn.style.display = 'none';
  } else {
    widget.style.display = 'none';
    openBtn.style.display = 'block';
  }
}
    </script>
<div id="scheduleWidget">
  <div class="widget-header">
    <h4 class="widget-title">ğŸ“… í˜‘íšŒ ë° ê´€ê³„ê¸°ê´€ ì£¼ìš”ì¼ì •</h4>
    <button onclick="toggleScheduleWidget()" id="closeScheduleBtn" class="widget-close">âœ–ï¸</button>
  </div>

  <div class="widget-body">
    <table class="schedule-table">
      <thead>
        <tr>
          <th style="width: 90px;">ì¼ì‹œ</th>
          <th>ë‚´ìš©</th>
          <th style="width: 80px;">ì¥ì†Œ</th>
          {% if user.role == 'admin' %}<th style="width: 50px;">ì‚­ì œ</th>{% endif %}
        </tr>
      </thead>
      <tbody id="scheduleList">
        <!-- ì—¬ê¸°ì— ì¼ì • ë‚´ìš©ì´ ë“¤ì–´ê° -->
      </tbody>
    </table>
  </div>
</div>

<!-- ë‹«ì€ ìƒíƒœ ì—´ê¸° ë²„íŠ¼ -->
<button onclick="toggleScheduleWidget()" id="openScheduleBtn" class="widget-open-btn">ğŸ“… ì¼ì • ì—´ê¸°</button>
</body>
</html>