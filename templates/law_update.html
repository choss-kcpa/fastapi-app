<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <title>ë²•ë ¹ ê°œì • í˜„í™©</title>
    <link rel="stylesheet" href="/static/law_update_styles.css?v=5">
</head>
<body>
    <!-- ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼ -->
    <div class="top-buttons">
        <button class="menu-button" onclick="location.href='/select-menu'">ë©”ë‰´ ì„ íƒìœ¼ë¡œ</button>
        <button class="logout-button" onclick="location.href='/logout'">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <h1>ë²•ë ¹ ê°œì • í˜„í™©</h1>

    <div class="search-container">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="categoryFilter" placeholder="êµ¬ë³„ ê²€ìƒ‰" oninput="filterLawUpdates()" />
        <input type="text" id="lawNameFilter" placeholder="ë²•ë ¹ëª… ê²€ìƒ‰" oninput="filterLawUpdates()" />
        <input type="date" id="dateFilter" oninput="filterLawUpdates()" />
        <input type="text" id="contentFilter" placeholder="ì£¼ìš”ë‚´ìš© ê²€ìƒ‰" oninput="filterLawUpdates()" />
        <button onclick="resetLawFilters()">ì´ˆê¸°í™”</button>
    </div>
    {% if user.role == 'admin' %}
    <div style="text-align: right; margin: 10px 20px;">
        <a href="/law-update/add-form" class="add-button">â• ìƒˆ ë²•ë ¹ ì¶”ê°€</a>
    </div>
{% endif %}
    <!-- ë²•ë ¹ ê°œì • í˜„í™© í…Œì´ë¸” -->
    <table>
        <thead>
            <tr>
                <th class="sortable" onclick="sortAmendments('category')">êµ¬ë³„</th>
                <th class="sortable" onclick="sortAmendments('law_name')">ë²•ë ¹ëª…</th>
                <th class="sortable" onclick="sortAmendments('proclamation_date')">ê³µí¬ì¼ì</th>
                <th class="sortable" onclick="sortAmendments('content')">ì£¼ìš”ë‚´ìš©</th>
                <th>ê´€ë ¨ ìë£Œ</th>
                <th class="sortable" onclick="sortAmendments('notice_date')">í–‰ì •ì˜ˆê³  ì¼ì</th>
                {% if user.role == 'admin' %}
                <th class="delete">ì‚­ì œ</th>
                {% endif %}
            </tr>
        </thead>
        <tbody id="amendmentTableBody">
            <!-- JavaScript ì—ì„œ ìë™ ë¡œë“œ ë©ë‹ˆë‹¤ -->
        </tbody>
    </table>

    <div id="pagination" style="text-align:center; margin-top:20px;"></div>

    <script>
    window.userRole = "{{ user.role }}";
    let currentSortColumn = null;
    let currentSortOrder = "asc";
    let allLaws = [];
    const itemsPerPage = 5;
    let currentPage = 1;

    function loadLawUpdates() {
        fetch("/law-update-data")
            .then(res => res.json())
            .then(data => {
                allLaws = data;
                currentPage = 1;
                displayLaws(allLaws);
            });
    }

    function filterLawUpdates() {
        const category = document.getElementById("categoryFilter").value.toLowerCase();
        const lawName = document.getElementById("lawNameFilter").value.toLowerCase();
        const date = document.getElementById("dateFilter").value;
        const content = document.getElementById("contentFilter").value.toLowerCase();

        const filtered = allLaws.filter(item =>
            (!category || item.category.toLowerCase().includes(category)) &&
            (!lawName || item.law_name.toLowerCase().includes(lawName)) &&
            (!date || item.proclamation_date === date) &&
            (!content || item.content.toLowerCase().includes(content))
        );

        displayLaws(filtered);
    }

    function resetLawFilters() {
        document.getElementById("categoryFilter").value = "";
        document.getElementById("lawNameFilter").value = "";
        document.getElementById("dateFilter").value = "";
        document.getElementById("contentFilter").value = "";

        displayLaws(allLaws);
    }

    function displayLaws(data) {
        const tbody = document.querySelector("#amendmentTableBody");
        tbody.innerHTML = "";

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = data.slice(start, end);

        pageData.forEach(item => {
            const row = document.createElement("tr");
            const fileLinks = item.file_list && item.file_list.length > 0
                ? item.file_list.map(f => `<div style="margin-bottom: 6px;"><a href="/files/${f}" download>${f.split('/').pop()}</a></div>`).join('')
                : 'ì—†ìŒ';

            row.innerHTML = `
                <td>${item.category}</td>
                <td>${item.law_name}</td>
                <td>${item.proclamation_date}</td>
                <td class="multiline" style="white-space: pre-wrap; text-align: left;">${item.content}</td>
                <td class="related-file">${fileLinks}</td>
                <td>${item.notice_date || ""}</td>
                ${window.userRole === 'admin' ? `
                <td>
                    <form action="/law-update/edit/${item.id}" method="get" style="display:inline-block;">
                        <button type="submit" class="edit-btn">ìˆ˜ì •</button>
                    </form>
                    <form action="/law-update/delete/${item.id}" method="post" style="display:inline-block;">
                        <button type="submit" class="delete-btn">ì‚­ì œ</button>
                    </form>
                </td>` : ''}
            `;
            tbody.appendChild(row);
        });

        renderPagination(data);
    }

    function sortAmendments(column) {
        allLaws.sort((a, b) => {
            let valueA = a[column];
            let valueB = b[column];

            if (column === "proclamation_date" || column === "notice_date") {
                valueA = new Date(valueA);
                valueB = new Date(valueB);
            }

            valueA = valueA ? valueA.toString().toLowerCase() : "";
            valueB = valueB ? valueB.toString().toLowerCase() : "";

            if (valueA < valueB) return currentSortOrder === "asc" ? -1 : 1;
            if (valueA > valueB) return currentSortOrder === "asc" ? 1 : -1;
            return 0;
        });

        displayLaws(allLaws);
    }

    function renderPagination(data) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const totalPages = Math.ceil(data.length / itemsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.innerText = i;
            btn.style.margin = "0 5px";
            btn.style.padding = "5px 10px";
            btn.style.cursor = "pointer";
            if (i === currentPage) btn.style.fontWeight = "bold";

            btn.onclick = () => {
                currentPage = i;
                displayLaws(data);
            };
            pagination.appendChild(btn);
        }
    }

    window.onload = loadLawUpdates;
    </script>
</body>
</html>
