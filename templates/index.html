<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìŠˆ ëª©ë¡</title>
    <style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(to bottom right, #fffef1, #ffffff); /* ì˜…ì€ ë…¸ë€ìƒ‰ ê·¸ë¼ë°ì´ì…˜ */
    background-attachment: fixed;
}
.top-bar {
    display: flex;
    justify-content: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
    align-items: center;
    padding: 15px 20px;
    background: transparent;
    border: none; 
    box-shadow: none;
}

.page-title {
    text-align: center;
    font-size: 42px;
    font-weight: bold;
    margin: 0px 0 0px;
    color: #003366;
}

/* ğŸ”¹ ë²„íŠ¼ ê·¸ë£¹ (ë¡œê·¸ì•„ì›ƒ & ë©”ë‰´ ì„ íƒ) */
.button-group {
    display: flex;
    gap: 10px;
}

/* ğŸ”¹ ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.button-group button {
    padding: 8px 20px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
}

/* ğŸ”¹ ë©”ë‰´ ì„ íƒ ë²„íŠ¼ (ì—°í•œ íŒŒë€ìƒ‰) */
.menu-btn {
    background-color: #4da6ff; /* ì—°í•œ íŒŒë€ìƒ‰ */
    color: white;
}

.menu-btn:hover {
    background-color: #007acc; /* ë” ì§„í•œ íŒŒë€ìƒ‰ */
}

/* ğŸ”¹ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ë¶‰ì€ìƒ‰ ê³„ì—´) */
.logout-btn {
    background-color: #ff4d4d;
    color: white;
}

.logout-btn:hover {
    background-color: #cc0000;
}
.filter-box {
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€í•˜ë©´ì„œ ì•„ë˜ 2ì¤„ ì¶”ê°€ */
    display: flex;
    flex-wrap: wrap;
    align-items: center;      /* âœ… ìˆ˜ì§ ì •ë ¬ */
    justify-content: center;  /* âœ… ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
    gap: 10px;
    background: linear-gradient(135deg, #a2e8f1, #a2e8f1);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    border: 1px solid #b2ebf2;
    margin: 20px 0;
}

/* ğŸ”· í•„í„° input/select í†µì¼ ìŠ¤íƒ€ì¼ */
.filter-box input,
.filter-box select {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 15px;
}

/* ğŸ”· ì´ˆê¸°í™” ë²„íŠ¼ë„ í†µì¼ */
.filter-box .reset-btn {
    border-radius: 8px;
    font-size: 15px;
    height: 40px;
    background-color: #6c757d;
    color: white;
}
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 2px solid #ebe2e28a;
            padding: 8px;
            text-align: center;
            font-size: 13px;
        }
        th {
            background-color: #f4f4f473;
        }
        .btn-container {
            margin-bottom: 10px;
        }
        .add-btn {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
        }
        .add-btn:hover {
            background-color: #0056b3;
        }
        .download-btn {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
        }
        .download-btn:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }
        /* âœ… ì´ìŠˆ ëª©ë¡ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ í…Œì´ë¸” ìš°ì¸¡ í•˜ë‹¨ìœ¼ë¡œ ì •ë ¬ */
        .download-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .completed {
        background-color: #d4edda; /* ì˜…ì€ ì´ˆë¡ìƒ‰ */
        }
        .in-progress {
        background-color: #fff3cd; /* ì˜…ì€ ë…¸ë€ìƒ‰ */
        }
        th.sortable {
        cursor: pointer;
        }
        th.sortable:hover {
        background-color: #e9ecef;
        }
        .update-icon {
        color: #ff4500;
        font-weight: bold;
        animation: blink 1s infinite;
        }

        @keyframes blink {
        50% {
            opacity: 0.3;
        }
        }
        .content-wrapper {
    padding: 0 20px; /* ì¢Œìš° ì—¬ë°± */
    max-width: 2000px; /* ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šë„ë¡ */
    margin: 0 auto; /* ê°€ìš´ë° ì •ë ¬ */
}

        .hidden-issue {
        background-color: #ffe6e6; /* ì—°í•œ ë¶„í™ìƒ‰ */
        }
    </style>
</head>
<body>
        <!-- âœ… ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í¬í•¨) -->
    <div class="top-bar">

        <div class="button-group">
            <button class="menu-btn" onclick="location.href='/select-menu'">ë©”ë‰´ ì„ íƒìœ¼ë¡œ</button>
            <button class="logout-btn" onclick="location.href='/logout'">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <h2 class="page-title">ì´ìŠˆ ëª©ë¡</h2>
    <!-- âœ… ê²€ìƒ‰ í•„í„° ì¶”ê°€ -->
    <div class="content-wrapper">
    <div class="filter-box">
    <input type="text" class="search-bar" id="searchInput" placeholder="ì´ìŠˆëª… ê²€ìƒ‰..." onkeyup="filterIssues()">
        <label>ë°œìƒì¼:</label>
    <input type="date" class="date-filter" id="startDate" onchange="filterIssues()">
    <input type="date" class="date-filter" id="endDate" onchange="filterIssues()">
    <label>ëŒ€ì‘ê¸°ê°„:</label>
<select id="filterPeriod" class="search-bar" onchange="filterIssues()">
    <option value="">ì „ì²´</option>
    <option value="ë‹¨ê¸°">ë‹¨ê¸°</option>
    <option value="ì¤‘ê¸°">ì¤‘ê¸°</option>
    <option value="ì¥ê¸°">ì¥ê¸°</option>
</select>

<label>ì¹´í…Œê³ ë¦¬:</label>
<select id="filterCategory" class="search-bar" onchange="filterIssues()">
    <option value="">ì „ì²´</option>
    <option value="ì œë„">ì œë„</option>
    <option value="ì•ˆì „ì„±">ì•ˆì „ì„±</option>
    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    <!-- í•„ìš”ì‹œ ë” ì¶”ê°€ -->
</select>

<label>ì •ë¶€ ê´€ê³„ì:</label>
<input type="text" id="filterGov" class="search-bar" placeholder="ì •ë¶€ ê´€ê³„ì ê²€ìƒ‰..." onkeyup="filterIssues()">

<label>Business Impact:</label>
<select id="filterImpact" class="search-bar" onchange="filterIssues()">
    <option value="">ì „ì²´</option>
    <option value="High">High</option>
    <option value="Medium">Medium</option>
    <option value="Low">Low</option>
</select>
    <button class="reset-btn" onclick="resetFilters()">ì´ˆê¸°í™”</button>
</div>

    <!-- âœ… "ì´ìŠˆ ì¶”ê°€" ë²„íŠ¼ (ê´€ë¦¬ìë§Œ ë³´ì´ê²Œ) -->
    <div class="btn-container admin-only">
        <button class="add-btn" onclick="location.href='/create-issue'">+ ì´ìŠˆ ì¶”ê°€</button>
        <button class="add-btn" onclick="location.href='/upload-excel'">ğŸ“‚ Excel ì—…ë¡œë“œ</button>
    </div>

    <table>
        <thead>
            <tr>
                <th class="sortable" onclick="sortIssues('issue_number')">ì´ìŠˆ ë²ˆí˜¸</th>
                <th class="sortable" onclick="sortIssues('issue_name')">ì´ìŠˆëª…</th>
                <th class="sortable" onclick="sortIssues('issue_date')">ë°œìƒì¼</th>
                <th class="sortable" onclick="sortIssues('response_period')">ëŒ€ì‘ê¸°ê°„</th>
                <th class="sortable" onclick="sortIssues('category')">ì¹´í…Œê³ ë¦¬</th>
                <th class="sortable" onclick="sortIssues('response_team')">ëŒ€ì‘íŒ€</th>
                <th class="sortable" onclick="sortIssues('government_officials')">ì •ë¶€ ê´€ê³„ì</th>
                <th class="sortable" onclick="sortIssues('business_impact')">Business Impact</th>
                <th class="sortable" onclick="sortIssues('kpi')">KPI</th>
                <th class="sortable" onclick="sortIssues('issue_end_date')">ì´ìŠˆ ì¢…ë£Œì¼(ì˜ˆì •ì¼)</th>
                <th class="sortable" onclick="sortIssues('stakeholders')">ì´í•´ê´€ê³„ì</th>
                <th class="sortable" onclick="sortIssues('completion_status')">ì™„ë£Œ ì—¬ë¶€</th>
                <th class="admin-only">ìˆ˜ì •</th>
                <th class="admin-only">ì‚­ì œ</th>
            </tr>
        </thead>
        <tbody id="issueTableBody">
            <!-- JavaScriptë¡œ ë°ì´í„° ì±„ìš°ê¸° -->
        </tbody>
    </table>

    <!-- âœ… ì´ìŠˆ ëª©ë¡ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ í…Œì´ë¸” ìš°ì¸¡ í•˜ë‹¨ì— ë°°ì¹˜ -->
    <div class="download-btn-container">
    </div>
        <button class="download-btn" onclick="downloadExcel()">ğŸ“¥ ì´ìŠˆëª©ë¡ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <script>
        let currentPage = 1;
        const pageSize = 12; // í•œ í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ í•­ëª© ìˆ˜
        let currentSortColumn = null;
let currentSortOrder = "asc";

function sortIssues(column) {
    // ì •ë ¬ ìˆœì„œ í† ê¸€
    if (currentSortColumn === column) {
        currentSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
    } else {
        currentSortOrder = "asc";
        currentSortColumn = column;
    }

    allIssues.sort((a, b) => {
        let valueA = a[column];
        let valueB = b[column];

        // ìˆ«ì í˜•ì‹ì´ë©´ ìˆ«ìë¡œ ë¹„êµ
        if (!isNaN(valueA) && !isNaN(valueB)) {
            valueA = parseFloat(valueA);
            valueB = parseFloat(valueB);
        } else {
            valueA = valueA ? valueA.toString().toLowerCase() : "";
            valueB = valueB ? valueB.toString().toLowerCase() : "";
        }

        if (valueA < valueB) return currentSortOrder === "asc" ? -1 : 1;
        if (valueA > valueB) return currentSortOrder === "asc" ? 1 : -1;
        return 0;
    });

    displayIssues(allIssues); // ì •ë ¬ í›„ ëª©ë¡ ë‹¤ì‹œ í‘œì‹œ
}
        function filterIssues() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const selectedPeriod = document.getElementById("filterPeriod").value;
            const selectedCategory = document.getElementById("filterCategory").value;
            const govKeyword = document.getElementById("filterGov").value.toLowerCase();
            const selectedImpact = document.getElementById("filterImpact").value;

            const filteredIssues = allIssues.filter(issue => {
            const issueNameMatch = issue.issue_name.toLowerCase().includes(searchInput);
            const issueDateMatch = (!startDate || issue.issue_date >= startDate) && (!endDate || issue.issue_date <= endDate);
            const periodMatch = !selectedPeriod || issue.response_period === selectedPeriod;
            const categoryMatch = !selectedCategory || issue.category === selectedCategory;
            const govMatch = !govKeyword || issue.government_officials.toLowerCase().includes(govKeyword);
            const impactMatch = !selectedImpact || issue.business_impact === selectedImpact;

    return issueNameMatch && issueDateMatch && periodMatch && categoryMatch && govMatch && impactMatch;
});

            displayIssues(filteredIssues);
        }

        function resetFilters() {
            document.getElementById("searchInput").value = "";
            document.getElementById("startDate").value = "";
            document.getElementById("endDate").value = "";
            document.getElementById("filterPeriod").value = "";
            document.getElementById("filterCategory").value = "";
            document.getElementById("filterGov").value = "";
            document.getElementById("filterImpact").value = "";
            displayIssues(allIssues);
        }
        
        let isAdmin = false;

        async function checkUserRole() {
            try {
                const response = await fetch("/current-user");
                const data = await response.json();

                if (data.role === "admin") {
                    isAdmin = true;
                }

                // âœ… ì´ìš©ì(user)ì¼ ê²½ìš° ë²„íŠ¼ ìˆ¨ê¹€
                if (!isAdmin) {
                    document.querySelectorAll(".admin-only").forEach(el => el.classList.add("hidden"));
                }
            } catch (error) {
                console.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }

        let allIssues = []; // ğŸ”¥ ëª¨ë“  ì´ìŠˆ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜

        async function loadIssues() {
    try {
        const response = await fetch("/issues-data", {
    credentials: "include"  // âœ… ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ ìœ„í•´ ê¼­ í•„ìš”
}); // âœ… ì¸ì¦ ì—†ì´ ì‘ë™í•˜ëŠ” API ì‚¬ìš©
        const data = await response.json();
        allIssues = data.data; // âœ… ì „ì²´ ì´ìŠˆ ë°ì´í„° ì €ì¥

        // ğŸ”¥ ë°œìƒì¼ ê¸°ì¤€ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
        allIssues.sort((a, b) => {
            const dateA = new Date(a.issue_date);
            const dateB = new Date(b.issue_date);
            return dateB - dateA; // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
        });

        displayIssues(allIssues);
    } catch (error) {
        console.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    }
}

        async function updateIssue(issueId) {
    const formData = new FormData(document.getElementById("editIssueForm"));

    const issueData = {
        issue_number: formData.get("issue_number"),
        issue_name: formData.get("issue_name"),
        issue_date: formData.get("issue_date"),
        response_period: formData.get("response_period"),
        category: formData.get("category"),
        response_team: formData.get("response_team"),
        government_officials: formData.get("government_officials"),
        business_impact: formData.get("business_impact"),
        kpi: formData.get("kpi"),
        issue_end_date: formData.get("issue_end_date"),
        stakeholders: formData.get("stakeholders"),
        result_summary: formData.get("result_summary"),
        completion_status: formData.get("completion_status"),
        other_remarks: formData.get("other_remarks")
    };

    const response = await fetch(`/issues/${issueId}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(issueData)
    });

    if (response.ok) {
        alert("ì´ìŠˆê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "/"; // âœ… ìˆ˜ì • í›„ ì´ìŠˆ ëª©ë¡ìœ¼ë¡œ ì´ë™
    } else {
        const data = await response.json();
        alert("ìˆ˜ì • ì‹¤íŒ¨: " + data.detail);
    }
}

function formatValue(value) {
    return value ? value : "-";  // ê°’ì´ ì—†ìœ¼ë©´ "-"ë¡œ í‘œì‹œ
}

function displayIssues(issues) {
    const tableBody = document.getElementById("issueTableBody");
    tableBody.innerHTML = "";

    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const paginatedIssues = issues.slice(startIndex, endIndex);

    paginatedIssues.forEach(issue => {
        const row = document.createElement("tr");
            // âœ… ìˆ¨ê¹€ ì´ìŠˆì¼ ê²½ìš° ë¶„í™ìƒ‰ ìŒì˜ ì²˜ë¦¬
        if (issue.is_hidden) {
            row.classList.add("hidden-issue");
        }
        if (issue.completion_status === "ì™„ë£Œ") {
            row.classList.add("completed");
        } else if (issue.completion_status === "ì§„í–‰ì¤‘") {
            row.classList.add("in-progress");
        }

        const isUpdated = (new Date() - new Date(issue.updated_at)) / (1000 * 60 * 60 * 24) <= 15;
        const updateIcon = isUpdated ? '<span class="update-icon">â˜…UPDATEâ˜…</span>' : '';

        row.innerHTML = `
            <td>${formatValue(issue.issue_number)}</td>
            <td><a href="/issue/${issue.id}">${formatValue(issue.issue_name)}</a> ${updateIcon}</td>
            <td>${formatValue(issue.issue_date)}</td>
            <td>${formatValue(issue.response_period)}</td>
            <td>${formatValue(issue.category)}</td>
            <td>${formatValue(issue.response_team)}</td>
            <td>${formatValue(issue.government_officials)}</td>
            <td>${formatValue(issue.business_impact)}</td>
            <td>${formatValue(issue.kpi)}</td>
            <td>${issue.issue_end_date ? issue.issue_end_date : 'ë¯¸ì •'}</td>
            <td>${formatValue(issue.stakeholders)}</td>
            <td>${formatValue(issue.completion_status)}</td>
            <td class="admin-only"><a href="/edit-issue/${issue.id}">ìˆ˜ì •</a></td>
            <td class="admin-only"><button onclick="deleteIssue(${issue.id})">ì‚­ì œ</button></td>
        `;
        tableBody.appendChild(row);
    });

    renderPagination(issues.length);
    checkUserRole();
}


function renderPagination(totalItems) {
    const existing = document.getElementById("pagination");
    if (existing) existing.remove();

    const totalPages = Math.ceil(totalItems / pageSize);
    if (totalPages <= 1) return;

    const container = document.createElement("div");
    container.id = "pagination";
    container.style.textAlign = "center";
    container.style.marginTop = "20px";

    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.style.margin = "0 5px";
        btn.style.padding = "6px 12px";
        btn.style.fontWeight = i === currentPage ? "bold" : "normal";
        btn.onclick = () => {
            currentPage = i;
            displayIssues(allIssues);
        };
        container.appendChild(btn);
    }

    document.body.appendChild(container);
}

        async function deleteIssue(issueId) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const response = await fetch(`/issues/${issueId}`, {
                method: "DELETE",
            });

            if (response.ok) {
                alert("ì´ìŠˆê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // âœ… ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨
            } else {
                const data = await response.json();
                alert("ì‚­ì œ ì‹¤íŒ¨: " + data.detail);
            }
        }

        function downloadExcel() {
            window.location.href = "/download-excel/";
        }

        checkUserRole();
        loadIssues();
    </script>

</body>
</html>