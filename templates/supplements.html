<!DOCTYPE html>
<html lang="ko">
    <head>
        <script>
            window.userRole = "{{ user.role }}";
        </script>
        <meta charset="UTF-8">
        <meta name="robots" content="noindex, nofollow">
        <title>ë“±ë¡ë³´ì™„ì‚¬í•­ ê´€ë¦¬</title>
        <link rel="stylesheet" href="/static/global.css?v=1002">
    </head>
<body>
    <div style="text-align: right; margin-bottom: 15px;">
        <a href="/select-menu" style="
            display: inline-block;
            background-color: #5faef3;
            color: white;
            padding: 6px 14px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
        ">ë©”ë‰´ì„ íƒìœ¼ë¡œ</a>
    </div>

    <h1>ë“±ë¡ë³´ì™„ì‚¬í•­ ê´€ë¦¬</h1>
    <div class="filter-box">
        <!-- ë‹ë³´ê¸° ì•„ì´ì½˜ ì¶”ê°€ -->
        <span style="font-size: 20px;">ğŸ”</span>
    
        <input type="date" id="supplementStart" onchange="filterSupplements()">
        <input type="date" id="supplementEnd" onchange="filterSupplements()">
    
        <select id="categoryFilter" onchange="filterSupplements()">
            <option value="">ë³´ì™„ë¶„ì•¼ ì „ì²´</option>
            <option value="ì´í™”í•™">ì´í™”í•™</option>
            <option value="ì•½íš¨ì•½í•´">ì•½íš¨ì•½í•´</option>
            <option value="ì”ë¥˜ì„±">ì”ë¥˜ì„±</option>
            <option value="ë…ì„±">ë…ì„±</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
    
        <input type="text" id="responderFilter" placeholder="ëŒ€ì‘ì£¼ì²´ ê²€ìƒ‰" onkeyup="filterSupplements()">
        <input type="text" id="contentFilter" placeholder="ë³´ì™„ë‚´ìš© ê²€ìƒ‰" onkeyup="filterSupplements()">
    
        <button class="reset-btn" onclick="resetSupplementFilters()">ì´ˆê¸°í™”</button>
    </div>
    {% if user.role == 'admin' %}
<div class="add-form">
    <a href="/supplements/add" class="add-button">â• ë³´ì™„ì‚¬í•­ ì¶”ê°€</a>
    <a href="#" class="add-button" onclick="document.getElementById('excelUpload').click()">ğŸ“ ì—‘ì…€ ì—…ë¡œë“œ</a>
    <form id="excelForm" action="/supplements/upload" method="post" enctype="multipart/form-data" style="display:none;">
        <input type="file" id="excelUpload" name="file" accept=".xlsx,.xls" onchange="document.getElementById('excelForm').submit()">
    </form>
</div>
{% endif %}
<script>
    window.userRole = "{{ user.role }}";
    
    let allSupplements = [];
    let filteredSupplements = [];
    let currentPage = 1;
    const itemsPerPage = 7;
    
    function loadSupplements() {
        fetch(`/supplements-all-data`)
            .then(res => res.json())
            .then(data => {
                allSupplements = data.data;
                filteredSupplements = allSupplements;
                currentPage = 1;
                displaySupplements({
                    data: filteredSupplements,
                    total_pages: Math.ceil(filteredSupplements.length / itemsPerPage)
                });
            });
    }
    
    function filterSupplements() {
        const start = document.getElementById("supplementStart").value;
        const end = document.getElementById("supplementEnd").value;
        const category = document.getElementById("categoryFilter").value;
        const responder = document.getElementById("responderFilter").value.toLowerCase();
        const content = document.getElementById("contentFilter").value.toLowerCase();
    
        const filtered = allSupplements.filter(item => {
            const dateMatch = (!start || item.supplement_date >= start) &&
                              (!end || item.supplement_date <= end);
            const categoryMatch = !category || item.category === category;
            const responderMatch = !responder || (item.responder && item.responder.toLowerCase().includes(responder));
            const contentMatch = !content || (item.content && item.content.toLowerCase().includes(content));
            return dateMatch && categoryMatch && responderMatch && contentMatch;
        });
    
        filteredSupplements = filtered;
        currentPage = 1;
        displaySupplements({
            data: filteredSupplements,
            total_pages: Math.ceil(filteredSupplements.length / itemsPerPage)
        });
    }
    
    function resetSupplementFilters() {
        document.getElementById("supplementStart").value = "";
        document.getElementById("supplementEnd").value = "";
        document.getElementById("categoryFilter").value = "";
        document.getElementById("responderFilter").value = "";
        document.getElementById("contentFilter").value = "";
    
        filteredSupplements = allSupplements;
        currentPage = 1;
        displaySupplements({
            data: filteredSupplements,
            total_pages: Math.ceil(filteredSupplements.length / itemsPerPage)
        });
    }
    
    function displaySupplements(apiResponse) {
    const data = apiResponse.data;
    const totalPages = apiResponse.total_pages;

    // ê¸°ì¡´ í•­ëª© ì œê±°
    document.querySelectorAll(".supplement-block, .data-table").forEach(el => el.remove());

    const container = document.body;

    // í…Œì´ë¸” ìƒì„±
    const table = document.createElement("table");
    table.className = "data-table";
    table.style.width = "95%";
    table.style.margin = "20px auto";

    // í…Œì´ë¸” í—¤ë” ìƒì„±
    table.innerHTML = `
        <thead>
            <tr style="background-color: #e3f2fd;">
                <th style="width: 120px;">ë³´ì™„ë‚ ì§œ</th>
                <th style="width: 100px;">ë³´ì™„ë¶„ì•¼</th>
                <th style="width: 100px;">ëŒ€ì‘ì£¼ì²´</th>
                <th>ë³´ì™„ë‚´ìš©</th>
                <th style="width: 200px;">ê´€ë ¨ìë£Œ</th>
                ${window.userRole === 'admin' ? '<th style="width: 100px;">ê¸°ëŠ¥</th>' : ''}
            </tr>
        </thead>
        <tbody id="supplementTableBody"></tbody>
    `;

    container.appendChild(table);
    const tbody = table.querySelector("tbody");

    // ë°ì´í„° ë Œë”ë§
    data
        .slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage)
        .forEach(item => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.supplement_date}</td>
                <td>${item.category}</td>
                <td>${item.responder}</td>
                <td class="multiline" style="white-space: pre-wrap; text-align: left;">${item.content}</td>
                <td>
                    ${item.file_list && item.file_list.length > 0
                        ? item.file_list.map(f => `<div><a href="/files/${f}" download>${f.split('/').pop()}</a></div>`).join('')
                        : 'ì—†ìŒ'}
                </td>
                ${window.userRole === 'admin' ? `
                    <td>
                        <form action="/supplements/delete/${item.id}" method="post" style="margin-bottom:5px;">
                            <button class="delete-btn">ì‚­ì œ</button>
                        </form>
                    </td>` : ''}
            `;
            tbody.appendChild(row);
        });

    // í˜ì´ì§€ë„¤ì´ì…˜ ê°±ì‹ 
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.style.margin = "0 4px";
        btn.style.padding = "6px 12px";
        btn.style.borderRadius = "6px";
        btn.style.border = "1px solid #ccc";
        btn.style.background = i === currentPage ? "#007bff" : "#f0f0f0";
        btn.style.color = i === currentPage ? "#fff" : "#333";
        btn.onclick = () => {
            currentPage = i;
            displaySupplements({
                data: filteredSupplements,
                total_pages: Math.ceil(filteredSupplements.length / itemsPerPage)
            });
        };
        pagination.appendChild(btn);
    }
}
    
    
    window.onload = function () {
        loadSupplements();
    };
    
    function openResponseEditor(id) {
        const method = prompt("ëŒ€ì‘ë°©ë²•(í˜„í™©)ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (method === null) return;
        const result = prompt("ëŒ€ì‘ê²°ê³¼ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (result === null) return;
    
        fetch(`/supplements/${id}/update-response`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ response_method: method, response_result: result })
        }).then(res => {
            if (res.ok) loadSupplements();
            else alert("ì €ì¥ ì‹¤íŒ¨!");
        });
    }
    </script>
<div id="pagination" style="text-align:center; margin: 30px 0;"></div>
</body>
</html>